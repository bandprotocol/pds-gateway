import os
from datetime import datetime
from typing import Dict

import httpx

from adapter.standard_crypto_price.base import StandardCryptoPrice, Input, Output


class CoinGecko(StandardCryptoPrice):
    api_url: str = "https://pro-api.coingecko.com/api/v3/simple/price"
    api_key: str
    symbols_map: Dict[str, str] = None
    symbols_map_back: Dict[str, str] = None

    def __init__(self):
        self.api_key = os.getenv("API_KEY", None)
        self.symbols_map = {
            "1INCH": "1inch",
            "AAVE": "aave",
            "ABYSS": "the-abyss",
            "ACH": "alchemy-pay",
            "ACS": "access-protocol",
            "ADA": "cardano",
            "AGIX": "singularitynet",
            "AKRO": "akropolis",
            "AKT": "akash-network",
            "ALCX": "alchemix",
            "ALGO": "algorand",
            "ALI": "alethea-artificial-liquid-intelligence-token",
            "ALICE": "my-neighbor-alice",
            "ALPHA": "alpha-finance",
            "ALUSD": "alchemix-usd",
            "AMP": "amp-token",
            "AMPL": "ampleforth",
            "ANKR": "ankr",
            "ANKRETH": "ankreth",
            "ANT": "aragon",
            "APE": "apecoin",
            "API3": "api3",
            "APT": "aptos",
            "AR": "arweave",
            "ARB": "arbitrum",
            "ARPA": "arpa",
            "AST": "airswap",
            "ASTR": "astar",
            "ASTRAFER": "astrafer",
            "ATOM": "cosmos",
            "AUDIO": "audius",
            "AUTO": "auto",
            "AVAX": "avalanche-2",
            "AVINOC": "avinoc",
            "AXL": "axelar",
            "AXS": "axie-infinity",
            "AZERO": "aleph-zero",
            "BABYDOGE": "baby-doge-coin",
            "BAL": "balancer",
            "BAND": "band-protocol",
            "BAT": "basic-attention-token",
            "BCH": "bitcoin-cash",
            "BDX": "beldex",
            "BEL": "bella-protocol",
            "BETA": "beta-finance",
            "BETH": "binance-eth",
            "BGB": "bitget-token",
            "BICO": "biconomy",
            "BIT": "bitdao",
            "BLUR": "blur",
            "BLZ": "bluzelle",
            "BNB": "binancecoin",
            "BNT": "bancor",
            "BOBA": "boba-network",
            "BONE": "bone-shibaswap",
            "BORA": "bora",
            "BRISE": "bitrise-token",
            "BSV": "bitcoin-cash-sv",
            "BTC": "bitcoin",
            "BTC.B": "bitcoin-avalanche-bridged-btc-b",
            "BTCB": "bitcoin-bep2",
            "BTG": "bitcoin-gold",
            "BTM": "bytom",
            "BTS": "bitshares",
            "BTSE": "btse-token",
            "BTT": "bittorrent",
            "BUSD": "binance-usd",
            "BZRX": "bzx-protocol",
            "C98": "coin98",
            "CAKE": "pancakeswap-token",
            "CDAI": "cdai",
            "CDT": "blox",
            "CELO": "celo",
            "CELR": "celer-network",
            "CET": "coinex-token",
            "CETH": "compound-ether",
            "CFX": "conflux-token",
            "CHR": "chromaway",
            "CHSB": "swissborg",
            "CHT": "cyberharbor",
            "CHZ": "chiliz",
            "CKB": "nervos-network",
            "CLV": "clover-finance",
            "COMBO": "cocos-bcx",
            "COMP": "compound-governance-token",
            "CORE": "coredaoorg",
            "CREAM": "cream-2",
            "CRO": "crypto-com-chain",
            "CRV": "curve-dao-token",
            "CSPR": "casper-network",
            "CTSI": "cartesi",
            "CUSD": "celo-dollar",
            "CUSDC": "compound-usd-coin",
            "CUSDT": "compound-usdt",
            "CVC": "civic",
            "CVX": "convex-finance",
            "CVXCRV": "convex-crv",
            "DAG": "constellation-labs",
            "DAI": "dai",
            "DAO": "dao-maker",
            "DASH": "dash",
            "DCR": "decred",
            "DEL": "decimal",
            "DESO": "deso",
            "DFI": "defichain",
            "DGB": "digibyte",
            "DIA": "dia-data",
            "DKA": "dkargo",
            "DOGE": "dogecoin",
            "DOT": "polkadot",
            "DPI": "defipulse-index",
            "DYDX": "dydx",
            "EDU": "edu-coin",
            "EGLD": "elrond-erd-2",
            "ELF": "aelf",
            "ELG": "escoin-token",
            "ELON": "dogelon-mars",
            "ENJ": "enjincoin",
            "ENS": "ethereum-name-service",
            "EOS": "eos",
            "ERG": "ergo",
            "ETC": "ethereum-classic",
            "ETH": "ethereum",
            "ETHW": "ethereum-pow-iou",
            "EURS": "stasis-eurs",
            "EURT": "tether-eurt",
            "EUSD": "eusd-27a558b0-8b5b-4225-a614-63539da936f4",
            "EVER": "everscale",
            "EWT": "energy-web-token",
            "EXRD": "e-radix",
            "FET": "fetch-ai",
            "FIL": "filecoin",
            "FLEX": "flex-coin",
            "FLOKI": "floki",
            "FLOW": "flow",
            "FLR": "flare-networks",
            "FLUX": "zelcash",
            "FNSA": "link",
            "FOR": "force-protocol",
            "FRAX": "frax",
            "FRXETH": "frax-ether",
            "FTM": "fantom",
            "FX": "fx-coin",
            "FXS": "frax-share",
            "GALA": "gala",
            "GFARM2": "gains-farm",
            "GLM": "golem",
            "GLMR": "moonbeam",
            "GLR": "canvas-n-glr",
            "GMT": "stepn",
            "GMX": "gmx",
            "GNO": "gnosis",
            "GNS": "gains-network",
            "GRT": "the-graph",
            "GT": "gatechain-token",
            "GUSD": "gemini-dollar",
            "HBAR": "hedera-hashgraph",
            "HBTC": "huobi-btc",
            "HEGIC": "hegic",
            "HIVE": "hive",
            "HNT": "helium",
            "HOT": "holotoken",
            "HT": "huobi-token",
            "ICP": "internet-computer",
            "ICX": "icon",
            "ID": "space-id",
            "ILV": "illuvium",
            "IMX": "immutable-x",
            "INJ": "injective-protocol",
            "IOST": "iostoken",
            "IOTX": "iotex",
            "JASMY": "jasmycoin",
            "JOE": "joe",
            "JST": "just",
            "KAI": "kardiachain",
            "KAS": "kaspa",
            "KAVA": "kava",
            "KCS": "kucoin-shares",
            "KDA": "kadena",
            "KEY": "selfkey",
            "KLAY": "klay-token",
            "KMD": "komodo",
            "KNC": "kyber-network-crystal",
            "KP3R": "keep3rv1",
            "KRD": "krypton-dao",
            "KSM": "kusama",
            "KUB": "bitkub-coin",
            "KUJI": "kujira",
            "LDO": "lido-dao",
            "LEO": "leo-token",
            "LINA": "linear",
            "LINK": "chainlink",
            "LOOM": "loom-network",
            "LPT": "livepeer",
            "LQTY": "liquity",
            "LRC": "loopring",
            "LSK": "lisk",
            "LTC": "litecoin",
            "LUNA": "terra-luna-2",
            "LUNC": "terra-luna",
            "LUSD": "liquity-usd",
            "LYXE": "lukso-token",
            "MAGIC": "magic",
            "MANA": "decentraland",
            "MASK": "mask-network",
            "MATIC": "matic-network",
            "MED": "medibloc",
            "METIS": "metis-token",
            "MIM": "magic-internet-money",
            "MINA": "mina-protocol",
            "MIOTA": "iota",
            "MKR": "maker",
            "MLK": "milk-alliance",
            "MLN": "melon",
            "MOVR": "moonriver",
            "MRS": "metars-genesis",
            "MSOL": "msol",
            "MTL": "metal",
            "MVL": "mass-vehicle-ledger",
            "MX": "mx-token",
            "NEAR": "near",
            "NEO": "neo",
            "NEXO": "nexo",
            "NFT": "apenft",
            "NMR": "numeraire",
            "NU": "nucypher",
            "NXM": "nxm",
            "NYM": "nym",
            "OCEAN": "ocean-protocol",
            "OGN": "origin-protocol",
            "OHM": "olympus",
            "OKB": "okb",
            "OKT": "oec-token",
            "OMG": "omisego",
            "OMI": "ecomi",
            "ONE": "harmony",
            "ONT": "ontology",
            "OP": "optimism",
            "ORDI": "ordinals",
            "OSMO": "osmosis",
            "PAXG": "pax-gold",
            "PEPE": "pepe",
            "PERP": "perpetual-protocol",
            "PLA": "playdapp",
            "PLR": "pillar",
            "PNK": "kleros",
            "PNT": "pnetwork",
            "POLY": "polymath",
            "POLYX": "polymesh",
            "POWR": "power-ledger",
            "PUNDIX": "pundi-x-2",
            "QKC": "quark-chain",
            "QNT": "quant-network",
            "QTUM": "qtum",
            "RAD": "radicle",
            "RBN": "ribbon-finance",
            "REN": "republic-protocol",
            "REP": "augur",
            "REQ": "request-network",
            "RETH": "rocket-pool-eth",
            "RIF": "rif-token",
            "RLB": "rollbit-coin",
            "RLC": "iexec-rlc",
            "RNDR": "render-token",
            "RON": "ronin",
            "ROSE": "oasis-network",
            "RPL": "rocket-pool",
            "RSR": "reserve-rights-token",
            "RSV": "reserve",
            "RUNE": "thorchain",
            "RVN": "ravencoin",
            "SAFEMOON": "safemoon",
            "SAND": "the-sandbox",
            "SAVAX": "benqi-liquid-staked-avax",
            "SC": "siacoin",
            "SCRT": "secret",
            "SETH2": "seth2",
            "SFI": "saffron-finance",
            "SFM": "safemoon-2",
            "SFP": "safepal",
            "SFRXETH": "staked-frax-ether",
            "SHIB": "shiba-inu",
            "SKL": "skale",
            "SLP": "smooth-love-potion",
            "SNT": "status",
            "SNX": "havven",
            "SOL": "solana",
            "SPELL": "spell-token",
            "SRM": "serum",
            "SSV": "ssv-network",
            "STETH": "staked-ether",
            "STG": "stargate-finance",
            "STMX": "storm",
            "STORJ": "storj",
            "STRD": "stride",
            "STRK": "strike",
            "STSOL": "lido-staked-sol",
            "STX": "blockstack",
            "SUI": "sui",
            "SUN": "sun-token",
            "SURE": "insure",
            "SUSD": "nusd",
            "SUSHI": "sushi",
            "SXP": "swipe",
            "SYN": "synapse-2",
            "SYS": "syscoin",
            "TEL": "telcoin",
            "TFUEL": "theta-fuel",
            "THETA": "theta-token",
            "TKX": "tokenize-xchange",
            "TOMI": "tominet",
            "TOMO": "tomochain",
            "TON": "the-open-network",
            "TRAC": "origintrail",
            "TRB": "tellor",
            "TRIBE": "tribe-2",
            "TRX": "tron",
            "TRYB": "bilira",
            "TUSD": "true-usd",
            "TWT": "trust-wallet-token",
            "UBT": "unibright",
            "ULT": "shardus",
            "UMA": "uma",
            "UNI": "uniswap",
            "UPP": "sentinel-protocol",
            "USDC": "usd-coin",
            "USDD": "usdd",
            "USDP": "paxos-standard",
            "USDT": "tether",
            "USTC": "terrausd",
            "UW3S": "utility-web3shot",
            "VET": "vechain",
            "VIDT": "v-id-blockchain",
            "VVS": "vvs-finance",
            "WAN": "wanchain",
            "WAVES": "waves",
            "WAXP": "wax",
            "WBETH": "wrapped-beacon-eth",
            "WBT": "whitebit",
            "WBTC": "wrapped-bitcoin",
            "WEMIX": "wemix-token",
            "WILD": "wilder-world",
            "WNXM": "wrapped-nxm",
            "WOO": "woo-network",
            "WRX": "wazirx",
            "XAUT": "tether-gold",
            "XCH": "chia",
            "XDC": "xdce-crowd-sale",
            "XEC": "ecash",
            "XEM": "nem",
            "XLM": "stellar",
            "XMR": "monero",
            "XNO": "nano",
            "XPR": "proton",
            "XRD": "radix",
            "XRP": "ripple",
            "XTZ": "tezos",
            "XVS": "venus",
            "YAMV2": "yam-v2",
            "YFI": "yearn-finance",
            "YFII": "yfii-finance",
            "YGG": "yield-guild-games",
            "ZEC": "zcash",
            "ZEN": "zencash",
            "ZIL": "zilliqa",
            "ZRX": "0x",
        }
        self.symbols_map_back = {v: k for k, v in self.symbols_map.items()}

    async def call(self, input_: Input) -> Output:
        client = httpx.AsyncClient()
        response = await client.request(
            "GET",
            self.api_url,
            params={
                "ids": ",".join([self.symbols_map.get(symbol, symbol) for symbol in input_["symbols"]]),
                "vs_currencies": "USD",
            },
            headers={
                "x-cg-pro-api-key": self.api_key,
            },
        )
        response.raise_for_status()
        response_json = response.json()

        timestamp = int(datetime.now().timestamp())
        prices = [
            {
                "symbol": self.symbols_map_back.get(symbol, symbol),
                "price": float(value["usd"]),
                "timestamp": timestamp,
            }
            for symbol, value in response_json.items()
        ]

        return Output(prices=prices)
